<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSR Module Usage Statistics</title>
    <style>
      body {
        font-family:
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          Helvetica,
          Arial,
          sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f4f7f6;
        color: #333;
      }

      h1 {
        text-align: center;
        color: #2a3d45;
        margin-bottom: 5px; /* Reduced margin below h1 */
      }

      /* Style for the source code link */
      .source-link {
        display: block; /* Make it a block element */
        text-align: center; /* Center the text */
        margin-bottom: 20px; /* Space below the link */
        font-size: 0.9em; /* Slightly smaller font */
      }
      .source-link a {
        color: #0056b3;
        text-decoration: none;
      }
      .source-link a:hover {
        text-decoration: underline;
      }

      /* Container for sorting controls */
      .sort-controls {
        text-align: center;
        margin-bottom: 20px;
      }
      .sort-controls label {
        margin-right: 8px;
        font-weight: bold;
      }
      .sort-controls select {
        padding: 5px 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background-color: #fff;
        cursor: pointer;
      }

      #statsTable {
        width: 85%; /* Slightly wider to accommodate new column */
        margin: 30px auto;
        border-collapse: collapse;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        background-color: #fff;
      }

      #statsTable th, #statsTable td {
        border: 1px solid #ddd;
        padding: 12px 15px;
        text-align: left;
        vertical-align: middle; /* Align content vertically */
      }

      #statsTable thead th {
        background-color: #4a7c59;
        color: #ffffff;
        font-weight: bold;
      }

      #statsTable tbody tr:nth-child(even) {
        background-color: #f9f9f9;
      }

      #statsTable tbody tr:hover {
        background-color: #eef;
      }

      /* Style links within the table */
      #statsTable td a {
        color: #0056b3; /* Standard link blue */
        text-decoration: none; /* Remove underline by default */
      }
      #statsTable td a:hover {
        text-decoration: underline; /* Underline on hover */
        color: #003d80;
      }

      /* Align numeric counts (Download & Dependent) to the right */
      #statsTable td:nth-child(4),
      #statsTable td:nth-child(5) {
        text-align: right;
        font-family: Consolas, monospace; /* Monospace for numbers */
      }

      /* Align numeric headers to the right as well */
      #statsTable th:nth-child(4),
      #statsTable th:nth-child(5) {
        text-align: right;
      }

      .loading, .error {
        text-align: center;
        padding: 20px;
        font-style: italic;
        color: #666;
      }
      .error {
        color: #d9534f;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>JSR Module Usage Statistics</h1>

    <!-- Source Code Link -->
    <div class="source-link">
      <a
        href="https://github.com/sigmaSd/jsr-stats"
        target="_blank"
        rel="noopener noreferrer"
      >
        Source Code on GitHub
      </a>
    </div>

    <!-- Sorting Controls -->
    <div class="sort-controls">
      <label for="sortSelect">Sort by:</label>
      <select id="sortSelect">
        <option value="count" selected>Download Count</option>
        <option value="dependentCount">Dependent Count</option>
      </select>
    </div>

    <table id="statsTable">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Scope</th>
          <th>Name</th>
          <th>Download Count</th>
          <th>Dependent Count</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- Data rows will be inserted here by JavaScript -->
        <tr>
          <td colspan="5" class="loading">Loading data...</td>
        </tr>
      </tbody>
    </table>

    <script>
      const tableBody = document.getElementById("tableBody");
      const sortSelect = document.getElementById("sortSelect"); // Get the select element
      const dataUrl = "/pkgs-count";
      const initialSortOrder = "desc"; // Always sort descending for counts

      let originalData = []; // Store the original fetched data

      // --- Data Fetching ---
      async function fetchData() {
        try {
          const response = await fetch(dataUrl);
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          originalData = await response.json(); // Store fetched data

          // Perform initial sort based on the default select value
          handleSort();
        } catch (error) {
          console.error("Error fetching data:", error);
          tableBody.innerHTML =
            `<tr><td colspan="5" class="error">Failed to load data: ${error.message}</td></tr>`; // Updated colspan
        }
      }

      // --- Sorting Logic ---
      function sortData(data, column, order = "desc") { // Default order to desc
        // Create a copy to avoid modifying the original fetched array if needed elsewhere
        const sortedData = [...data];

        sortedData.sort((a, b) => {
          let valA = a[column];
          let valB = b[column];

          // Handle potential missing values for dependentCount gracefully
          valA = valA === undefined || valA === null ? 0 : valA;
          valB = valB === undefined || valB === null ? 0 : valB;

          // Handle numeric vs string comparison (though both counts should be numeric)
          if (typeof valA === "number" && typeof valB === "number") {
            return order === "asc" ? valA - valB : valB - valA;
          } else {
            // Fallback for unexpected types (less likely with counts)
            valA = String(valA).toLowerCase();
            valB = String(valB).toLowerCase();
            if (valA < valB) return order === "asc" ? -1 : 1;
            if (valA > valB) return order === "asc" ? 1 : -1;
            return 0;
          }
        });
        return sortedData;
      }

      // --- Rendering Logic ---
      function renderTable(data) {
        tableBody.innerHTML = ""; // Clear previous content

        if (!data || data.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="5" class="loading">No data found.</td></tr>'; // Updated colspan
          return;
        }

        data.forEach((item, idx) => { // Use forEach directly with index
          const row = tableBody.insertRow();

          // Rank Cell
          const rankCell = row.insertCell();
          rankCell.textContent = idx + 1;

          // Scope Cell (with link)
          const scopeCell = row.insertCell();
          const scopeLink = document.createElement("a");
          scopeLink.href = `https://jsr.io/@${item.scope}`;
          scopeLink.textContent = item.scope;
          scopeLink.target = "_blank";
          scopeLink.rel = "noopener noreferrer";
          scopeCell.appendChild(scopeLink);

          // Name Cell (with link)
          const nameCell = row.insertCell();
          const nameLink = document.createElement("a");
          nameLink.href = `https://jsr.io/@${item.scope}/${item.name}`;
          nameLink.textContent = item.name;
          nameLink.target = "_blank";
          nameLink.rel = "noopener noreferrer";
          nameCell.appendChild(nameLink);

          // Download Count Cell
          const countCell = row.insertCell();
          // Use 0 if count is missing/null
          countCell.textContent = (item.count ?? 0).toLocaleString();

          // Dependent Count Cell (New)
          const dependentCountCell = row.insertCell();
          // Use 0 if dependentCount is missing/null
          dependentCountCell.textContent = (item.dependentCount ?? 0)
            .toLocaleString();
        });
      }

      // --- Handle Sorting ---
      function handleSort() {
        const sortByColumn = sortSelect.value; // Get selected column ('count' or 'dependentCount')
        const sortedData = sortData(
          originalData,
          sortByColumn,
          initialSortOrder,
        );
        renderTable(sortedData);
      }

      // --- Initial Load & Event Listener ---
      document.addEventListener("DOMContentLoaded", fetchData); // Fetch data on load
      sortSelect.addEventListener("change", handleSort); // Re-sort when selection changes
    </script>
  </body>
</html>
